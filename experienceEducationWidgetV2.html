<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
</head>

<body>
    <style>
        /* table {
            border: 1px solid #ccc;
            border-collapse: collapse;
            margin: 0;
            padding: 0;
            width: 100%;
            table-layout: fixed;
        }

        table caption {
            font-size: 1.5em;
            margin: .5em 0 .75em;
        }

        table tr {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: .35em;
        }

         table th,
        table td {
            padding: .625em;
            text-align: center;
        }

        table th {
            font-size: .85em;
            letter-spacing: .1em;
            text-transform: uppercase;
        } */
        @media screen and (max-width: 800px) {
            table {
                border: 1px solid #ccc;
                border-collapse: collapse;
                margin: 0;
                padding: 0;
                width: 100%;
                table-layout: fixed;
            }

            /* Hide table headers (but not display: none;, for accessibility) */
            table th {
                position: absolute;
                top: -9999px;
                left: -9999px;
                overflow: hidden;
            }

            table caption {
                font-size: 1.5em;
                margin: .5em 0 .75em;
            }

            table tr {
                background-color: #f8f8f8;
                border: 1px solid #ddd;
                padding: .35em;
            }

            table th,
            table td {
                padding: .625em;
                text-align: center;
            }

            table th {
                font-size: .85em;
                letter-spacing: .1em;
                text-transform: uppercase;
            }

            table {
                border: 0;
                max-width: 500px;
            }

            table caption {
                font-size: 1.3em;
            }

            table thead {
                border: none;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
            }

            table tr {
                border-bottom: 3px solid #ddd;
                display: block;
                margin-bottom: .625em;
            }

            table td {
                border-bottom: 1px solid #ddd;
                display: block;
                font-size: .8em;
                text-align: right;
            }

            table td::before {
                /*
    * aria-label has no advantage, it won't be read inside a table
    content: attr(aria-label);
    */
                content: attr(data-label);
                float: left;
                font-weight: bold;
                text-transform: uppercase;
            }

            table td:last-child {
                border-bottom: 0;
            }

            /*
		Label the data
    You could also use a data-* attribute and content for this. That way "bloats" the HTML, this way means you need to keep HTML and CSS in sync. Lea Verou has a clever way to handle with text-shadow.
		*/

            td:nth-of-type(1):before {
                content: " ";
            }

            td:nth-of-type(2):before {
                content: "Select a type of activity";
            }

            td:nth-of-type(3):before {
                content: "Company";
            }

            td:nth-of-type(4):before {
                content: "Institution";
            }

            td:nth-of-type(5):before {
                content: "Start Date";
            }

            td:nth-of-type(6):before {
                content: "End Date";
            }

            td:nth-of-type(7):before {
                content: "Position Held";
            }

            td:nth-of-type(8):before {
                content: "Grade Band";
            }

            td:nth-of-type(9):before {
                content: "Results";
            }

            td:nth-of-type(10):before {
                content: "Comments";
            }

            td:nth-of-type(11):before {
                content: " ";
            }
        }
    </style>
    <script type="text/javascript">

        var numOfIncorrectDates = 0;
        var currFullWorkHistory = "No";

        //Global functions
        function modFields(rowNumber, activityType) {
            console.log(activityType)

            //rowNumber = rowNumber - 1;
            const nameOfEmployerId = "nameOfEmployer" + rowNumber;
            const institutionId = "institution" + rowNumber;
            const positionHeldId = "positionHeld" + rowNumber;
            const gradeBandId = "gradeBand" + rowNumber;
            const resultsId = "results" + rowNumber;
            switch (activityType) {
                case "Employed":
                    document.getElementById(nameOfEmployerId).value = "";
                    document.getElementById(institutionId).value = "";
                    document.getElementById(gradeBandId).value = "";
                    document.getElementById(resultsId).value = "";
                    document.getElementById(positionHeldId).value = "";

                    document.getElementById(nameOfEmployerId).disabled = false;
                    document.getElementById(institutionId).disabled = true;
                    document.getElementById(gradeBandId).disabled = false;
                    document.getElementById(resultsId).disabled = true;
                    document.getElementById(positionHeldId).disabled = false;
                    break;
                case "Traveling":
                    document.getElementById(nameOfEmployerId).value = "";
                    document.getElementById(institutionId).value = "";
                    document.getElementById(gradeBandId).value = "";
                    document.getElementById(resultsId).value = "";
                    document.getElementById(positionHeldId).value = "";

                    document.getElementById(nameOfEmployerId).disabled = true;
                    document.getElementById(institutionId).disabled = true;
                    document.getElementById(gradeBandId).disabled = true;
                    document.getElementById(resultsId).disabled = true;
                    document.getElementById(positionHeldId).disabled = true;
                    break;
                case "Unemployed":
                    document.getElementById(nameOfEmployerId).value = "";
                    document.getElementById(institutionId).value = "";
                    document.getElementById(gradeBandId).value = "";
                    document.getElementById(resultsId).value = "";
                    document.getElementById(positionHeldId).value = "";

                    document.getElementById(nameOfEmployerId).disabled = true;
                    document.getElementById(institutionId).disabled = true;
                    document.getElementById(gradeBandId).disabled = true;
                    document.getElementById(resultsId).disabled = true;
                    document.getElementById(positionHeldId).disabled = true;
                    break;
                case "Studying":
                    document.getElementById(nameOfEmployerId).value = "";
                    document.getElementById(institutionId).value = "";
                    document.getElementById(gradeBandId).value = "";
                    document.getElementById(resultsId).value = "";
                    document.getElementById(positionHeldId).value = "";

                    document.getElementById(nameOfEmployerId).disabled = true;
                    document.getElementById(institutionId).disabled = false;
                    document.getElementById(gradeBandId).disabled = false;
                    document.getElementById(resultsId).disabled = false;
                    document.getElementById(positionHeldId).disabled = true;
                    break;
                case "Other":
                    document.getElementById(nameOfEmployerId).value = "";
                    document.getElementById(institutionId).value = "";
                    document.getElementById(gradeBandId).value = "";
                    document.getElementById(resultsId).value = "";
                    document.getElementById(positionHeldId).value = "";

                    document.getElementById(nameOfEmployerId).disabled = true;
                    document.getElementById(institutionId).disabled = true;
                    document.getElementById(gradeBandId).disabled = true;
                    document.getElementById(resultsId).disabled = true;
                    document.getElementById(positionHeldId).disabled = true;
                    break;
                default:
                    document.getElementById(nameOfEmployerId).disabled = false;
                    document.getElementById(institutionId).disabled = false;
                    document.getElementById(gradeBandId).disabled = false;
                    document.getElementById(resultsId).disabled = false;
                    document.getElementById(positionHeldId).disabled = false;
            }
        }

        function getData(fieldToFill) {
            var tblData = $('tr').not(':first').map(function () {
                var obj = {};
                $(this).find('input, select, textarea').each(function () {
                    if (this.name !== "") {
                        obj[this.name] = $(this).val();
                    }
                });
                return obj;
            }).get();
            // console.log(JSON.stringify(tblData));
            JFCustomWidget.setFieldsValueById([{ id: fieldToFill, value: JSON.stringify(tblData) }]);
            return { valid: true, value: JSON.stringify(tblData) };
        }

        function validateDates() {
            const currRowLength = document.getElementsByName("Start Date")?.length

            for (let i = 0; i < currRowLength; i++) {
                let currEndDate = document.getElementsByName("End Date")[i]?.value; //check undefinded
                let currStartDate = document.getElementsByName("Start Date")[i + 1]?.value; //check undefinded
                if (currFullWorkHistory === "Yes") {
                    var dateDiffRes = [{
                        id: "215",
                        value: ""
                    }]
                }
                else {
                    var dateDiffRes = [{
                        id: "439",
                        value: ""
                    }]
                }
                console.log("EmpTo", currEndDate)
                console.log("EmpFrom", currStartDate)
                if (currEndDate != null && currStartDate != null) {
                    document.getElementsByName("End Date")[i].style = "background-color: none;"
                    document.getElementsByName("End Date")[i + 1].style = "background-color: none;"
                    document.getElementsByName("Start Date")[i].style = "background-color: none;"
                    document.getElementsByName("Start Date")[i + 1].style = "background-color: none;"
                    console.log("all good")
                    if (getMonthDifference(new Date(currEndDate), new Date(currStartDate)) >= 1) {
                        document.getElementsByName("End Date")[i].style = "background-color: red;"
                        document.getElementsByName("Start Date")[i + 1].style = "background-color: red;"
                        console.log("1 month data diff")

                        dateDiffRes[0].value = "Yes";
                        console.log("Invalid dates = ", dateDiffRes)

                        JFCustomWidget.setFieldsValueById(dateDiffRes);
                        console.log("here")
                        numOfIncorrectDates = numOfIncorrectDates + 1
                        //return { value: "Yes", valid: false };
                    }
                    else {
                        document.getElementsByName("End Date")[i].style = "background-color: none;"
                        document.getElementsByName("Start Date")[i + 1].style = "background-color: none;"
                        dateDiffRes[0].value = "No";
                        console.log("Valid dates = ", dateDiffRes)
                        JFCustomWidget.setFieldsValueById(dateDiffRes);
                        numOfIncorrectDates = numOfIncorrectDates - 1;
                    }
                    //add coomments to array
                }
            }
            console.log(numOfIncorrectDates)
            if (numOfIncorrectDates >= 1) {
                document.getElementById("textArea").innerHTML = "The date(s) above highlighted in red have a gap greater then 1 month, please mention why in the field below";
                // JFCustomWidget.sendData({ value: "Yes" });
                resizeFrame();
            }
            else {
                document.getElementById("textArea").innerHTML = "";
                resizeFrame();
                // JFCustomWidget.sendData({ value: "No" });
            }
        }

        function getMonthDifference(startDate, endDate) {
            return (
                endDate.getMonth() -
                startDate.getMonth() +
                12 * (endDate.getFullYear() - startDate.getFullYear())
            );
        }

        function deleteRow(id) {
            var table = document.getElementById('emptbl');
            var rowCount = table.rows.length;
            if (rowCount === 1) {
                console.log("There should be atleast one row");
                return
            }
            else if (rowCount > 2) {
                var row = table.deleteRow(id);
                resizeFrame();
                validateDates();
                return
                //rowCount--;
            }
        }

        function moveRowUp(tblRow) {
            // $("tblHeading").prev(tblRow )
            const prevRow = $(tblRow).prev()[0].id
            console.log(prevRow)
            if (prevRow === "tblHeading") {
                console.log("here");
                return;
            }
            console.log($(tblRow).prev()[0])
            $(tblRow).prev().before($(tblRow));
            validateDates();
            return
        }

        function moveRowDown(tblRow) {
            const nextRow = $(tblRow).next();
            if (nextRow.length === 0) {
                console.log("length ", nextRow.length);
                return;
            }
            $(tblRow).next().after($(tblRow));
            validateDates();
            return;
        }

        function resizeFrame() {
            const currHeight = $("form").height();
            JFCustomWidget.requestFrameResize({ width: 1000, height: currHeight + 10 })
        }

        $(function () {
            function EducationExperienceList(containerId, formData, params) {

                var yearOfBirth;
                var fieldToStoreData = params["storageField"];

                /**
               * Exposed
               */
                this.init = init;
                this.getData = getData;
                this.setCompanyNames = setCompanyNames;
                this.resizeFrame = resizeFrame;
                this.restoreTableData = restoreTableData;
                this.makeWidgetRequiredOrNot = makeWidgetRequiredOrNot

                const currMaxYear = maxYear();


                //mobile
                // $('#listContainer').css('overflow-x', 'auto');

                function init() {
                    // $('#' + containerId).attr('data-widget-name', 'e7ce64589c330d6bb7bf8c25').html(buildHTML);
                    console.log("form Data = ", formData)
                    console.log("form data value = ", formData.value)

                    if (formData.value !== undefined) {
                        restoreTableData(JSON.parse(formData.value))
                    }
                    if (params["fullWorkHistory"] === "Yes") {
                        JFCustomWidget.getFieldsValueById(["31"], function (res) {
                            console.log("res by Name= ", res.data[0].value);
                            const strDate = res.data[0].value;

                            const [day, month, year] = strDate.split('/');
                            console.log(month);
                            console.log(day);
                            console.log(year);
                            const correctDateFormat = new Date(+year, +month - 1, +day);
                            console.log(correctDateFormat);

                            yearOfBirth = (new Date(correctDateFormat)).getFullYear();
                            console.log("Year Of Birth = ", yearOfBirth);
                        });
                    }
                    // Create a condition that targets viewports at least 800px wide
                    const mediaQuery = window.matchMedia('(min-width: 800px)')

                    function handleScreenChange(e) {
                        if (e.matches) {
                            console.log('Matched!')
                            resizeFrame();
                        }
                        else {
                            console.log("Doesn't Match!")
                            resizeFrame();
                        }
                    }

                    mediaQuery.addListener(handleScreenChange)

                    handleScreenChange(mediaQuery)

                    $('#addRowButton').on('click', function (event) {
                        addRow();
                    });

                    $('input, select, textarea').on('change', function (event) {
                        makeWidgetRequiredOrNot();
                        JFCustomWidget.sendData(getData(fieldToStoreData))
                    })
                    $("input[type=date]").attr("min", currMaxYear);

                }

                function makeWidgetRequiredOrNot() {
                    console.log("here")
                    //Validate years since school leaving age
                    if (!JFCustomWidget.isWidgetRequired()) {
                        if ($('input:invalid').length >= 1) {
                            console.log(JFCustomWidget.isWidgetRequired())
                            JFCustomWidget.makeWidgetRequired();
                            JFCustomWidget.showWidgetError("Please make sure that all fields are correctly filled in")
                        }
                        if (document.getElementById("emptbl").rows.length <= 1) {
                            JFCustomWidget.makeWidgetRequired();
                        }
                        else {
                            JFCustomWidget.makeWidgetNotRequired();
                            JFCustomWidget.hideWidgetError();
                        }
                    }
                }

                function maxYear() {
                    var maxYearForDates;
                    if (params["fullWorkHistory"] === "Yes") {
                        maxYearForDates = yearOfBirth + 18;
                    }
                    else {
                        maxYearForDates = new Date().getFullYear() - 5;
                    }
                    console.log(maxYearForDates + "-01" + "-01")
                    //input.setAttribute("min", maxYearForDates);
                    return maxYearForDates + "-01" + "-01"
                }

                // const currMaxYear = maxYear();


                function addRow(isPop, popData) {
                    if ($('input:invalid').length >= 1) {
                        makeWidgetRequiredOrNot(); //May not be required
                        return
                    }
                    var table = document.getElementById("emptbl");
                    // GET TOTAL NUMBER OF ROWS 
                    var x = table.rows.length;
                    var id = "tbl" + x;
                    var row = table.insertRow(x);
                    row.id = id;
                    // var rowNumberCell = row.insertCell(0);
                    var moveButtonsCell = row.insertCell(0);
                    var typeOfActivityCell = row.insertCell(1);
                    var companyCell = row.insertCell(2);
                    var institutionCell = row.insertCell(3);
                    var startDateCell = row.insertCell(4);
                    var endDateCell = row.insertCell(5);
                    var positionHeldCell = row.insertCell(6);
                    var gradeBandCell = row.insertCell(7)
                    var resultsCell = row.insertCell(8);
                    var commentsCell = row.insertCell(9);
                    var deleteRowCell = row.insertCell(10);
                    // rowNumberCell.outerHTML = `<th style="padding: 20px; fontSize:30px;" name="rowNumberColumn[]" id="rowNumber${x}">≡</th>`;
                    moveButtonsCell.innerHTML = `<button type="button" id="upRow${x}" onclick="moveRowUp(${id})">Up</button> <button type="button" id="downRow${x}" onclick="moveRowDown(${id})">Down</button>`;
                    typeOfActivityCell.innerHTML = `<select onchange="modFields(${x}, this.value)" name="Type of Activity" value="0" id="typeOfActivity${x}" required >
                        <option value="">Select Type of activity</option>
                        <option value="Employed">Employed</option>
                        <option value="Traveling">Traveling</option>
                        <option value="Unemployed">Unemployed</option>
                        <option value="Studying">Studying</option>
                        <option value="Other">Other</option>
                    </select>`;
                    companyCell.innerHTML = `<input type="text" name="Name of Employer" value="" id="nameOfEmployer${x}" required />`;
                    institutionCell.innerHTML = `<input type="text" name="Institution" value="" id="institution${x}" required />`;
                    startDateCell.innerHTML = `<input type="date" name="Start Date" min=${currMaxYear} onchange="validateDates()" value="" id="startDate${x}" required />`;
                    endDateCell.innerHTML = `<input type="date" name="End Date" min=${currMaxYear} onchange="validateDates()" value="" id="endDate${x}" />`;
                    positionHeldCell.innerHTML = `<input type="text" name="Position Held" value="" id="positionHeld${x}" required />`;
                    gradeBandCell.innerHTML = `<input type="text" name="Grade/Band" value="" id="gradeBand${x}" required />`;
                    resultsCell.innerHTML = `<input type="text" name="Results" value="" id="results${x}" required />`;
                    commentsCell.innerHTML = `<textarea type="text" name="Comments" value="" id="comments${x}" required />`;
                    deleteRowCell.innerHTML = `<button type="button" id="deleteRow${x}" onclick="deleteRow(${x})">Delete</button>`;

                    //set values
                    if (isPop) {
                        document.getElementById(`typeOfActivity${x}`).value = popData["Type of Activity"] ?? "";
                        modFields(x, popData["Type of Activity"] ?? "");
                        document.getElementById(`nameOfEmployer${x}`).value = popData["Name of Employer"] ?? "";
                        document.getElementById(`institution${x}`).value = popData["Institution"] ?? "";
                        document.getElementById(`startDate${x}`).value = popData["Start Date"] ?? "";
                        document.getElementById(`endDate${x}`).value = popData["End Date"] ?? "";
                        document.getElementById(`positionHeld${x}`).value = popData["Position Held"] ?? "";
                        document.getElementById(`gradeBand${x}`).value = popData["Grade/Band"] ?? "";
                        document.getElementById(`results${x}`).value = popData["Results"] ?? "";
                        document.getElementById(`comments${x}`).value = popData["Comments"] ?? ""
                    }

                    resizeFrame();
                    JFCustomWidget.sendData(getData(fieldToStoreData));
                }

                function getCompanyNames() {
                    const currRowLength = document.getElementsByName("Name of Employer")?.length
                    console.log("Employer by name = ", document.getElementsByName("Name of Employer"))
                    let arr = []
                    for (let i = 0; i < currRowLength; i++) {
                        let currNameOfEmployer = document.getElementsByName("Name of Employer")[i]?.value; //check undefinded
                        let currActType = document.getElementsByName("Type of Activity")[i]?.value; //check undefinded
                        console.log("Em", currActType)
                        console.log("nameEm", currNameOfEmployer)
                        if (currNameOfEmployer != null && currActType === "Employed" && arr.length < 6) {
                            arr.push(currNameOfEmployer);
                        }
                    }
                    console.log("arr length = ", arr.length)
                    return arr;
                }

                function restoreTableData(dataObj) {
                    try {
                        dataObj.forEach(function (obj) {
                            if (Object.keys(obj).length !== 0) {
                                console.log(obj)
                                addRow(true, obj)
                            }
                        })

                    } catch (error) {
                        console.log(error)
                        return
                    }
                }

                function setCompanyNames(fieldIds) {
                    let currNames = getCompanyNames();
                    let fillArr = []
                    for (let i = 0; i < fieldIds.length; i++) {
                        if (currNames[i] !== undefined && currNames[i] !== "") {
                            fillArr.push({
                                id: fieldIds[i],
                                value: currNames[i]
                            })
                        }
                    }
                    JFCustomWidget.setFieldsValueById(fillArr);
                    console.log(fillArr)
                }
            }

            JFCustomWidget.subscribe('ready', function (data) {
                // console.log('Education Experience List ready', data);
                var widget = new EducationExperienceList('Test01', data, JFCustomWidget.getWidgetSettings());
                widget.init();
                widget.resizeFrame();

                JFCustomWidget.subscribe('populate', fillConditionValue);

                function fillConditionValue(data) {
                    JFCustomWidget.hideWidgetError();

                    var tbl = document.getElementById("emptbl");

                    currFullWorkHistory = JFCustomWidget.getWidgetSetting("fullWorkHistory");

                    console.log(currFullWorkHistory)

                    if (currFullWorkHistory === "Yes" && data.value !== "") {
                        widget.restoreTableData(JSON.parse(data.value));
                    }
                    // JFCustomWidget.sendData(getData(fieldToStoreData));
                }

                console.log(JFCustomWidget)

                JFCustomWidget.subscribe('submit', function () {
                    const widgetParm = JFCustomWidget.getWidgetSettings();
                    if (widgetParm["fullWorkHistory"] === "No") {
                        widget.setCompanyNames([widgetParm["companyField1"], widgetParm["companyField2"], widgetParm["companyField3"], widgetParm["companyField4"], widgetParm["companyField5"], widgetParm["companyField6"]]);
                    }

                    console.log(widgetParm["storageField"]);

                    // send the data
                    JFCustomWidget.sendSubmit(widget.getData(widgetParm["storageField"]));
                });

            });
        })

    </script>
    <form style="overflow:auto; width: 100%;" id="educationExperienceList[]" name="educationExperienceList" action="#">
        <table id="emptbl">
            <tbody>
                <tr id="tblHeading">
                    <h3 style="max-width: 500px;">Click the Add Row button to add an Education or Experience</h3>
                    <th> </th>
                    <th>Type of activity</th>
                    <th>Company</th>
                    <th>Institution</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Position Held</th>
                    <th>Grade/Band</th>
                    <th>Results</th>
                    <th>Comments</th>
                    <th> </th>
                </tr>
            </tbody>
        </table>
        <table>
            <tr>
                <button type="button" id="addRowButton">Add Row</button>
                <span>
                    <p id="textArea"></p>
                </span>
            </tr>
        </table>
    </form>
</body>

</html>

<!--
    Todo

-->