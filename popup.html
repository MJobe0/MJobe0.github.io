<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotForm SweetAlert Widget</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent;
        }
        
        #alert-widget-container {
            width: 100%;
            min-height: 30px;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .status-indicator {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .ready {
            background-color: #e8f4ff;
            color: #0F5DBD;
        }
        
        .triggered {
            background-color: #ffebeb;
            color: #d63031;
        }
        
        .settings-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="alert-widget-container">
        <div class="status-indicator ready">Alert Ready</div>
        <div class="settings-summary" id="settingsSummary"></div>
    </div>
    
    <script>
        let widgetSettings = {};
        let lastValue = null;
        let isAlertTriggered = false;
        let autoResetTimer = null;
        
        JFCustomWidget.subscribe("ready", function(message) {
            widgetSettings = JFCustomWidget.getWidgetSettings();
            console.log("Widget settings:", widgetSettings);
            
            updateSettingsSummary();
            
            if (widgetSettings.triggerOnLoad === "Yes" || widgetSettings.triggerOnLoad === "1" || widgetSettings.triggerOnLoad === true) {
                setTimeout(function() {
                    showAlert(
                        widgetSettings.defaultMessage || "This is an automatic alert.",
                        widgetSettings.defaultTitle || "Alert",
                        widgetSettings.alertType || "info"
                    );
                }, 1000);
            }
            
            resizeFrame();
            
            if (typeof swal !== 'function') {
                $(".status-indicator").removeClass("ready").addClass("triggered").text("SweetAlert library not loaded");
                console.error("SweetAlert library not found. Make sure it's properly loaded.");
            }
        });
        
        JFCustomWidget.subscribe("populate", function(data) {
            console.log("Received data:", data);
            
            if (data.value === lastValue && lastValue !== null) {
                console.log("Skipping duplicate trigger value:", data.value);
                return;
            }
            
            lastValue = data.value;
            
            if (widgetSettings.messageSource === "settings" || !data.value) {
                if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showAlert(
                        widgetSettings.defaultMessage || "Attention required!",
                        widgetSettings.defaultTitle || "Alert",
                        widgetSettings.alertType || "warning"
                    );
                }
            }
            else {
                let message = data.value;
                let title = widgetSettings.defaultTitle || "Alert";
                let alertType = widgetSettings.alertType || "warning";
                let showCancel = widgetSettings.showCancelButton === "Yes" || widgetSettings.showCancelButton === "1" || widgetSettings.showCancelButton === true;
                let timer = widgetSettings.autoHide === "Yes" || widgetSettings.autoHide === "1" || widgetSettings.autoHide === true ? 
                          (parseInt(widgetSettings.autoHideDelay) || 5) * 1000 : null;
                
                if (data.value.includes(';') && data.value.includes(':')) {
                    const parts = parseDataString(data.value);
                    
                    const shouldTrigger = parts.trigger && (
                        parts.trigger[0] === 1 || 
                        parts.trigger[0] === true || 
                        parts.trigger[0] === "1" || 
                        parts.trigger[0] === "true"
                    );
                    
                    if (shouldTrigger || parts.message) {
                        message = parts.message ? parts.message[0] : (widgetSettings.defaultMessage || "Attention required!");
                        
                        if (parts.title) {
                            title = parts.title[0];
                        }
                        
                        if (parts.type) {
                            alertType = parts.type[0];
                        }
                        
                        if (parts.showCancel) {
                            showCancel = parts.showCancel[0] === true || 
                                       parts.showCancel[0] === 1 || 
                                       parts.showCancel[0] === "1" || 
                                       parts.showCancel[0] === "true";
                        }
                        
                        if (parts.timer) {
                            timer = parts.timer[0] === false || parts.timer[0] === 0 || parts.timer[0] === "0" || parts.timer[0] === "false" ?
                                 null : parseInt(parts.timer[0]) * 1000;
                        }
                        
                        showAlert(message, title, alertType, showCancel, timer);
                    }
                } 
                else if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showAlert(data.value, title, alertType, showCancel, timer);
                }
            }
            
            resizeFrame();
        });
        
        JFCustomWidget.subscribe("submit", function() {
            const data = {
                valid: true,
                value: ""
            };
            JFCustomWidget.sendSubmit(data);
        });
        
        function showAlert(message, title = "Alert", type = "info", showCancel = false, timer = null) {
            if (typeof swal !== 'function') {
                console.error("SweetAlert library not loaded.");
                alert(message);
                return;
            }
            
            isAlertTriggered = true;
            $(".status-indicator").removeClass("ready").addClass("triggered").text("Alert Triggered");
            
            if (autoResetTimer) {
                clearTimeout(autoResetTimer);
                autoResetTimer = null;
            }
            
            let icon;
            switch(type.toLowerCase()) {
                case "success":
                    icon = "success";
                    break;
                case "error":
                    icon = "error";
                    break;
                case "warning":
                    icon = "warning";
                    break;
                case "info":
                default:
                    icon = "info";
            }
            
            const swalOptions = {
                title: title,
                text: message,
                icon: icon,
                buttons: showCancel ? {
                    cancel: {
                        text: "Cancel",
                        visible: true,
                        className: "",
                        closeModal: true,
                    },
                    confirm: {
                        text: "OK",
                        value: true,
                        visible: true,
                        className: "",
                        closeModal: true
                    }
                } : {
                    confirm: {
                        text: "OK",
                        value: true,
                        visible: true,
                        className: "",
                        closeModal: true
                    }
                }
            };
            
            if (timer) {
                swalOptions.timer = timer;
            }
            
            swal(swalOptions).then(() => {
                resetIndicator();
            });
            
            if (widgetSettings.autoReset === "Yes" || widgetSettings.autoReset === "1" || widgetSettings.autoReset === true) {
                const delay = parseInt(widgetSettings.resetDelay) || 10; // Default 10 seconds
                autoResetTimer = setTimeout(function() {
                    resetIndicator();
                }, delay * 1000);
            }
        }
        
        function resetIndicator() {
            isAlertTriggered = false;
            $(".status-indicator").removeClass("triggered").addClass("ready").text("Alert Ready");
        }
        
        function updateSettingsSummary() {
            let summary = "";
            
            if (widgetSettings.defaultTitle) {
                summary += `Title: "${widgetSettings.defaultTitle}"<br>`;
            }
            
            if (widgetSettings.defaultMessage) {
                summary += `Message: "${widgetSettings.defaultMessage.substring(0, 30)}${widgetSettings.defaultMessage.length > 30 ? '...' : ''}"<br>`;
            }
            
            if (widgetSettings.alertType) {
                summary += `Type: ${widgetSettings.alertType}<br>`;
            }
            
            if (widgetSettings.triggerOnLoad === "Yes" || widgetSettings.triggerOnLoad === "1" || widgetSettings.triggerOnLoad === true) {
                summary += "Show on load: Yes<br>";
            }
            
            if (widgetSettings.autoHide === "Yes" || widgetSettings.autoHide === "1" || widgetSettings.autoHide === true) {
                summary += `Auto-hide: Yes (${parseInt(widgetSettings.autoHideDelay) || 5}s)<br>`;
            }
            
            if (widgetSettings.showCancelButton === "Yes" || widgetSettings.showCancelButton === "1" || widgetSettings.showCancelButton === true) {
                summary += "Show cancel button: Yes<br>";
            }
            
            if (widgetSettings.messageSource) {
                summary += `Message source: ${widgetSettings.messageSource}<br>`;
            }
            
            $("#settingsSummary").html(summary);
        }
        
        function parseDataString(dataString) {
            const datasets = {};
            const parts = dataString.split(';');
            
            parts.forEach(part => {
                if (part.includes(':')) {
                    const [key, values] = part.split(':');
                    if (key && values) {
                        if (['message', 'type', 'title'].includes(key.trim())) {
                            datasets[key.trim()] = [values];
                        } else {
                            datasets[key.trim()] = values.split(',').map(val => {
                                const numVal = Number(val);
                                return isNaN(numVal) ? val : numVal;
                            });
                        }
                    }
                }
            });
            
            return datasets;
        }
        
        function resizeFrame() {
            const height = $("#alert-widget-container").outerHeight() + 20;
            JFCustomWidget.requestFrameResize({
                height: height
            });
        }
    </script>
</body>
</html>
