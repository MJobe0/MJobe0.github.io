<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotForm Native Alert Widget</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent;
        }
        
        #alert-widget-container {
            width: 100%;
            min-height: 30px;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* Widget status indicator */
        .status-indicator {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .ready {
            background-color: #e8f4ff;
            color: #0F5DBD;
        }
        
        .triggered {
            background-color: #ffebeb;
            color: #d63031;
        }
        
        .settings-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="alert-widget-container">
        <div class="status-indicator ready">Alert Ready</div>
        <div class="settings-summary" id="settingsSummary"></div>
    </div>
    
    <script>
        let widgetSettings = {};
        let lastValue = null;
        let isAlertTriggered = false;
        
        JFCustomWidget.subscribe("ready", function(message) {
            widgetSettings = JFCustomWidget.getWidgetSettings();
            console.log("Widget settings:", widgetSettings);
            
            updateSettingsSummary();
            
            if (widgetSettings.triggerOnLoad === "Yes" || widgetSettings.triggerOnLoad === "1" || widgetSettings.triggerOnLoad === true) {
                setTimeout(function() {
                    showAlert(widgetSettings.defaultMessage || "This is an automatic alert.");
                }, 1000);
            }
            
            resizeFrame();
        });
        
        JFCustomWidget.subscribe("populate", function(data) {
            console.log("Received data:", data);
            
            if (data.value === lastValue && lastValue !== null) {
                console.log("Skipping duplicate trigger value:", data.value);
                return;
            }
            
            lastValue = data.value;
            
            if (widgetSettings.messageSource === "settings" || !data.value) {
                if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showAlert(widgetSettings.defaultMessage || "Attention required!");
                }
            }
            else {
                let message = data.value;
                let alertType = "warning";
                
                if (data.value.includes(';') && data.value.includes(':')) {
                    const parts = parseDataString(data.value);
                    
                    if (parts.trigger && (parts.trigger[0] === 1 || parts.trigger[0] === true || 
                                        parts.trigger[0] === "1" || parts.trigger[0] === "true")) {
                        message = parts.message ? parts.message[0] : "Attention required!";
                        
                        if (parts.type) {
                            alertType = parts.type[0];
                        }
                        
                        showAlert(message, alertType);
                    }
                    else if (parts.message) {
                        message = parts.message[0];
                        
                        if (parts.type) {
                            alertType = parts.type[0];
                        }
                        
                        showAlert(message, alertType);
                    }
                } 
                else if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showAlert(data.value, alertType);
                }
            }
            
            resizeFrame();
        });
        
        JFCustomWidget.subscribe("submit", function() {
            const data = {
                valid: true,
                value: ""
            };
            JFCustomWidget.sendSubmit(data);
        });
        
        function showAlert(message, type = "warning") {
            isAlertTriggered = true;
            $(".status-indicator").removeClass("ready").addClass("triggered").text("Alert Triggered");
            
            try {
                if (typeof JFCustomWidget.showWidgetError === 'function') {
                    JFCustomWidget.showWidgetError(message);
                } 
                else if (window.parent && window.parent.JotForm) {
                    let alertFunction;
                    
                    switch(type.toLowerCase()) {
                        case "error":
                            alertFunction = window.parent.JotForm.errored;
                            break;
                        case "success":
                            alertFunction = window.parent.JotForm.success;
                            break;
                        case "info":
                            alertFunction = window.parent.JotForm.info;
                            break;
                        case "warning":
                        default:
                            alertFunction = window.parent.JotForm.warning;
                    }
                    
                    if (typeof alertFunction === 'function') {
                        alertFunction(null, message);
                    } else {
                        alert(message);
                    }
                } 
                else {
                    alert(message);
                }
                
                if (widgetSettings.autoReset === "Yes" || widgetSettings.autoReset === "1" || widgetSettings.autoReset === true) {
                    const delay = parseInt(widgetSettings.resetDelay) || 5;
                    setTimeout(function() {
                        resetIndicator();
                    }, delay * 1000);
                }
                
            } catch (e) {
                console.error("Error showing alert:", e);
                alert(message);
            }
        }
        
        function resetIndicator() {
            isAlertTriggered = false;
            $(".status-indicator").removeClass("triggered").addClass("ready").text("Alert Ready");
        }
        
        function updateSettingsSummary() {
            let summary = "";
            
            if (widgetSettings.defaultMessage) {
                summary += `Default message: "${widgetSettings.defaultMessage.substring(0, 30)}${widgetSettings.defaultMessage.length > 30 ? '...' : ''}"<br>`;
            }
            
            if (widgetSettings.triggerOnLoad === "Yes" || widgetSettings.triggerOnLoad === "1" || widgetSettings.triggerOnLoad === true) {
                summary += "Auto-trigger on load: Yes<br>";
            }
            
            if (widgetSettings.messageSource) {
                summary += `Message source: ${widgetSettings.messageSource}<br>`;
            }
            
            if (widgetSettings.autoReset === "Yes" || widgetSettings.autoReset === "1" || widgetSettings.autoReset === true) {
                summary += `Auto-reset: Yes (${parseInt(widgetSettings.resetDelay) || 5}s)<br>`;
            }
            
            $("#settingsSummary").html(summary);
        }
        
        function parseDataString(dataString) {
            const datasets = {};
            const parts = dataString.split(';');
            
            parts.forEach(part => {
                if (part.includes(':')) {
                    const [key, values] = part.split(':');
                    if (key && values) {
                        if (key.trim() === 'message' || key.trim() === 'type') {
                            datasets[key.trim()] = [values];
                        } else {
                            datasets[key.trim()] = values.split(',').map(val => {
                                const numVal = Number(val);
                                return isNaN(numVal) ? val : numVal;
                            });
                        }
                    }
                }
            });
            
            return datasets;
        }
        
        function resizeFrame() {
            const height = $("#alert-widget-container").outerHeight() + 20;
            JFCustomWidget.requestFrameResize({
                height: height
            });
        }
    </script>
</body>
</html>
