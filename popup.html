<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotForm Inline Notification</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: transparent;
        }
        
        #notification-widget-container {
            width: 100%;
            box-sizing: border-box;
            padding: 0;
            min-height: 30px;
        }
        
        /* Notification styles */
        .notification {
            display: none;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
            box-sizing: border-box;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .notification-content {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 22px;
            line-height: 0.8;
            cursor: pointer;
            padding: 5px;
            color: inherit;
            opacity: 0.6;
        }
        
        .close-btn:hover {
            opacity: 1;
        }
        
        /* Notification types */
        .info {
            background-color: #e8f4fd;
            border-left: 4px solid #2196F3;
            color: #0c5ea3;
        }
        
        .info .close-btn {
            color: #0c5ea3;
        }
        
        .success {
            background-color: #e8f6ee;
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
        }
        
        .success .close-btn {
            color: #2e7d32;
        }
        
        .warning {
            background-color: #fff8e6;
            border-left: 4px solid #FFC107;
            color: #b38707;
        }
        
        .warning .close-btn {
            color: #b38707;
        }
        
        .error {
            background-color: #fde8e8;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        
        .error .close-btn {
            color: #c62828;
        }
        
        /* Status indicators */
        .status-indicator {
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .ready {
            background-color: #e8f4ff;
            color: #0F5DBD;
        }
        
        .triggered {
            background-color: #ffebeb;
            color: #d63031;
        }
        
        .settings-summary {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        /* Hidden in edit mode */
        .form-edit-mode .notification {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="notification-widget-container">
        <div class="status-indicator ready">Notification Ready</div>
        
        <!-- Notification element -->
        <div id="notification" class="notification">
            <div class="notification-header">
                <div id="notification-title" class="notification-title">Important Notice</div>
                <button id="close-notification" class="close-btn">&times;</button>
            </div>
            <div id="notification-content" class="notification-content">
                Notification message will appear here.
            </div>
        </div>
        
        <div class="settings-summary" id="settingsSummary"></div>
    </div>
    
    <script>
        let widgetSettings = {};
        let lastValue = null;
        let isNotificationShown = false;
        let autoHideTimer = null;
        
        $(document).ready(function() {
            $("#close-notification").click(function() {
                hideNotification();
            });
            
            if (window.location.href.indexOf('builder.jotform.com') > -1) {
                $('body').addClass('form-edit-mode');
            }
        });
        
        JFCustomWidget.subscribe("ready", function(message) {
            widgetSettings = JFCustomWidget.getWidgetSettings();
            console.log("Widget settings:", widgetSettings);
            
            updateNotificationFromSettings();
            
            updateSettingsSummary();
            
            if (widgetSettings.showOnLoad === "Yes" || widgetSettings.showOnLoad === "1" || widgetSettings.showOnLoad === true) {
                setTimeout(function() {
                    showNotification(
                        widgetSettings.defaultMessage || "This is an automatic notification.",
                        widgetSettings.notificationType || "info"
                    );
                }, 1000);
            }
            
            resizeFrame();
        });
        
        JFCustomWidget.subscribe("populate", function(data) {
            console.log("Received data:", data);
            
            if (data.value === lastValue && lastValue !== null) {
                console.log("Skipping duplicate trigger value:", data.value);
                return;
            }
            
            lastValue = data.value;
            
            if (widgetSettings.messageSource === "settings" || !data.value) {
                if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showNotification(
                        widgetSettings.defaultMessage || "Attention required!",
                        widgetSettings.notificationType || "warning"
                    );
                }
            }
            else {
                let message = data.value;
                let notificationType = widgetSettings.notificationType || "warning";
                let title = widgetSettings.defaultTitle || "Attention";
                let shouldShake = widgetSettings.enableShake === "Yes" || widgetSettings.enableShake === "1" || widgetSettings.enableShake === true;
                
                if (data.value.includes(';') && data.value.includes(':')) {
                    const parts = parseDataString(data.value);
                    
                    const shouldTrigger = parts.trigger && (
                        parts.trigger[0] === 1 || 
                        parts.trigger[0] === true || 
                        parts.trigger[0] === "1" || 
                        parts.trigger[0] === "true"
                    );
                    
                    if (shouldTrigger || parts.message) {
                        message = parts.message ? parts.message[0] : (widgetSettings.defaultMessage || "Attention required!");
                        
                        if (parts.type) {
                            notificationType = parts.type[0];
                        }
                        
                        if (parts.title) {
                            title = parts.title[0];
                        }
                        
                        if (parts.shake) {
                            shouldShake = parts.shake[0] === true || 
                                         parts.shake[0] === 1 || 
                                         parts.shake[0] === "1" || 
                                         parts.shake[0] === "true";
                        }
                        
                        showNotification(message, notificationType, title, shouldShake);
                    }
                } 
                else if (data.value && data.value !== "0" && data.value.toLowerCase() !== "false") {
                    showNotification(data.value, notificationType);
                }
            }
            
            resizeFrame();
        });
        
        JFCustomWidget.subscribe("submit", function() {
            const data = {
                valid: true,
                value: ""
            };
            JFCustomWidget.sendSubmit(data);
        });
        
        function updateNotificationFromSettings() {
            if (widgetSettings.defaultTitle) {
                $("#notification-title").text(widgetSettings.defaultTitle);
            }
            
            if (widgetSettings.defaultMessage) {
                $("#notification-content").text(widgetSettings.defaultMessage);
            }
            
            // Set notification type/style if provided
            if (widgetSettings.notificationType) {
                setNotificationType(widgetSettings.notificationType);
            }
        }
        
        function showNotification(message, type = "info", title = null, shake = false) {
            if (autoHideTimer) {
                clearTimeout(autoHideTimer);
                autoHideTimer = null;
            }
            
            $("#notification-content").html(message);
            
            if (title) {
                $("#notification-title").text(title);
            } else if (widgetSettings.defaultTitle) {
                $("#notification-title").text(widgetSettings.defaultTitle);
            }
            
            setNotificationType(type);
            
            $("#notification").fadeIn(300);
            isNotificationShown = true;
            
            if (shake || (widgetSettings.enableShake === "Yes" || widgetSettings.enableShake === "1" || widgetSettings.enableShake === true)) {
                $("#notification").removeClass("shake").outerWidth(); // Force reflow
                $("#notification").addClass("shake");
            }
            
            $(".status-indicator").removeClass("ready").addClass("triggered").text("Notification Shown");
            
            if (widgetSettings.autoHide === "Yes" || widgetSettings.autoHide === "1" || widgetSettings.autoHide === true) {
                const delay = parseInt(widgetSettings.autoHideDelay) || 5;
                autoHideTimer = setTimeout(function() {
                    hideNotification();
                }, delay * 1000);
            }
            
            resizeFrame();
        }
        
        // Helper function to set notification type and styling
        function setNotificationType(type) {
            // Remove any existing type classes
            $("#notification").removeClass("info success warning error");
            
            // Add the appropriate type class
            switch(type.toLowerCase()) {
                case "success":
                    $("#notification").addClass("success");
                    break;
                case "warning":
                    $("#notification").addClass("warning");
                    break;
                case "error":
                    $("#notification").addClass("error");
                    break;
                case "info":
                default:
                    $("#notification").addClass("info");
            }
        }
        
        function hideNotification() {
            $("#notification").fadeOut(300);
            
            setTimeout(function() {
                $(".status-indicator").removeClass("triggered").addClass("ready").text("Notification Ready");
            }, 500);
            
            isNotificationShown = false;
            
            setTimeout(resizeFrame, 350);
        }
        
        // Helper function to update settings summary display
        function updateSettingsSummary() {
            let summary = "";
            
            if (widgetSettings.defaultTitle) {
                summary += `Title: "${widgetSettings.defaultTitle}"<br>`;
            }
            
            if (widgetSettings.defaultMessage) {
                summary += `Message: "${widgetSettings.defaultMessage.substring(0, 30)}${widgetSettings.defaultMessage.length > 30 ? '...' : ''}"<br>`;
            }
            
            if (widgetSettings.notificationType) {
                summary += `Type: ${widgetSettings.notificationType}<br>`;
            }
            
            if (widgetSettings.showOnLoad === "Yes" || widgetSettings.showOnLoad === "1" || widgetSettings.showOnLoad === true) {
                summary += "Show on load: Yes<br>";
            }
            
            if (widgetSettings.autoHide === "Yes" || widgetSettings.autoHide === "1" || widgetSettings.autoHide === true) {
                summary += `Auto-hide: Yes (${parseInt(widgetSettings.autoHideDelay) || 5}s)<br>`;
            }
            
            if (widgetSettings.enableShake === "Yes" || widgetSettings.enableShake === "1" || widgetSettings.enableShake === true) {
                summary += "Shake effect: Enabled<br>";
            }
            
            if (widgetSettings.messageSource) {
                summary += `Message source: ${widgetSettings.messageSource}<br>`;
            }
            
            $("#settingsSummary").html(summary);
        }
        
        function parseDataString(dataString) {
            const datasets = {};
            const parts = dataString.split(';');
            
            parts.forEach(part => {
                if (part.includes(':')) {
                    const [key, values] = part.split(':');
                    if (key && values) {
                        if (['message', 'type', 'title'].includes(key.trim())) {
                            datasets[key.trim()] = [values];
                        } else {
                            datasets[key.trim()] = values.split(',').map(val => {
                                const numVal = Number(val);
                                return isNaN(numVal) ? val : numVal;
                            });
                        }
                    }
                }
            });
            
            return datasets;
        }
        
        function resizeFrame() {
            const containerHeight = $("#notification-widget-container").outerHeight();
            const notificationHeight = isNotificationShown ? $("#notification").outerHeight() : 0;
            const totalHeight = containerHeight + notificationHeight + 20; // Add padding
            
            JFCustomWidget.requestFrameResize({
                height: totalHeight
            });
        }
    </script>
</body>
</html>
