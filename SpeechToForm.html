<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/themes/CSS/5e6b428acc8c4e222d1beb91.css?v=3.3.57758" />
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/css/styles/payment/payment_styles.css?3.3.57758" />
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/css/styles/payment/payment_feature.css?3.3.57758" />
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/stylebuilder/static/form-common.css?v=3c1609c" />
</head>

<body>
    <div id="recorder-container">
        <button id="record-btn">Start Recording</button>
        <input type="file" id="upload-file" accept="audio/*" style="display:none">
        <button id="upload-btn">Upload Audio</button>
        <p id="transcription-output">Transcription: <span id="transcribed-text"></span></p>
    </div>

    <script>
        "use strict";

        var params;
        var audioBlob = null;
        var mediaRecorder;
        var isRecording = false;

        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // Step 1: Start Recording Speech
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();

                    document.getElementById('record-btn').textContent = "Stop Recording";
                    isRecording = true;

                    mediaRecorder.ondataavailable = function (event) {
                        const audioBlob = event.data;

                        // Convert Blob to File to ensure compatibility with backend
                        const audioFile = new File([audioBlob], "recording.webm", { type: "audio/webm" });
                        sendAudioToAPI(audioFile);
                    };
                })
                .catch(function (err) {
                    console.error('Error accessing microphone: ', err);
                });
        }

        // Step 2: Stop Recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                document.getElementById('record-btn').textContent = "Start Recording";
                isRecording = false;
            }
        }

        document.getElementById('record-btn').addEventListener('click', toggleRecording);

        // Handle File Upload
        document.getElementById('upload-btn').addEventListener('click', function () {
            document.getElementById('upload-file').click(); // Open file dialog
        });

        // When a file is selected, upload it
        document.getElementById('upload-file').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                sendAudioToAPI(file); // Send the selected file
            }
        });

        // Step 3: Sending Audio to Hugging Face API
        function sendAudioToAPI(audioFile) {
            const formData = new FormData();
            formData.append('file', audioFile);
            formData.append('questions', JSON.stringify(params.fieldMapping || {}));

            const apiUrl = 'https://mjobe-document-vqa-v2.hf.space/transcribe_and_answer/';

            fetch(apiUrl, {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const transcribedText = data.transcription;
                    document.getElementById('transcribed-text').innerText = transcribedText;
                    prefillFormFields(data);
                })
                .catch(error => {
                    console.error('Error fetching transcription:', error);
                });
        }

        // Step 4: Prefill form fields based on transcription
        function prefillFormFields(apiResponse) {
            const transcription = apiResponse.transcription;
            const answers = apiResponse.answers;
            document.getElementById('transcribed-text').innerText = transcription;

            Object.keys(answers).forEach(fieldId => {
                const fieldValue = answers[fieldId];
                JFCustomWidget.setFieldsValueById([{
                    id: fieldId,
                    value: fieldValue
                }]);
            });

            JFCustomWidget.sendData(transcription);
        }

        function resizeFrame() {
            const currHeight = $("body").height();
            JFCustomWidget.requestFrameResize({ width: 1000, height: currHeight });
        }

        JFCustomWidget.subscribe('populate', function (data) {
            console.log("Populate Data:", data);
        });

        JFCustomWidget.subscribe('ready', function (data) {
            params = JFCustomWidget.getWidgetSettings();
        });

        JFCustomWidget.subscribe('submit', function (data) {
            console.log("Form submitted with:", data);
        });

    </script>
</body>

</html>