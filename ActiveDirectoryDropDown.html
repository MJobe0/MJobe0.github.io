<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/themes/CSS/5e6b428acc8c4e222d1beb91.css?v=3.3.57758" />
    <link type="text/css" rel="stylesheet"
        href="https://digiblu.jotform.com/stylebuilder/static/form-common.css?v=3c1609c" />
    <!-- Optional JavaScript -->
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script');
            po.type = 'text/javascript';
            po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(po, s);
        })();
    </script>
</head>

<style>
    * {
        margin: 0px;
        padding: 0px;
        border: 0px;
        box-sizing: border-box;
    }

    body {
        background: #f4f4f4;
        font: 14px Tahoma, Geneva, sans-serif;
        text-align: center;
    }

    h1 {
        padding: 10px;
        color: #333;
        font-size: 20px;
    }

    .dropdown-container {
        margin: 20px 0;
    }

    select {
        padding: 10px;
        margin: 10px;
        border-radius: 5px;
        font-size: 14px;
        width: 300px;
        cursor: pointer;
    }

    #progress-message {
        margin-top: 10px;
        font-size: 14px;
        color: #333;
    }
</style>

<body>
    <div class="signer-dropdown" id="signerDropdown">
        <div class="dropdown-container form-dropdown" >
            <label for="signer1">Email:</label>
            <select id="signer1"></select>
        </div>
        <p id="progress-message"></p>
    </div>

    <script>
        "use strict";

        var params;

        const locationDropdown = document.getElementById("locationDropdown");
        const signerDropdown = document.getElementById("signerDropdown");
        const progressMessage = document.getElementById("progress-message");

        let signer1Value;

        function updateSignerDropdown(signerId, emails) {
            const signerSelect = document.getElementById(signerId);
            signerSelect.innerHTML = "";

            emails.forEach((email) => {
                const option = document.createElement("option");
                option.value = email.userPrincipalName;
                option.textContent = email.userPrincipalName;
                signerSelect.appendChild(option);
            });

            signerSelect.value = emails[0];

            signerSelect.addEventListener("change", function () {
                storeSelectedValue(signerId, signerSelect.value);
                setEmailValueToField();
            });
        }

        function storeSelectedValue(signerId, value) {
            if (signerId === "signer1") {
                signer1Value = value;
            }
            console.log(`Updated ${signerId} value:`, value);
        }

        function setEmailValueToField() {
            console.log("Email value: ", signer1Value);
            console.log("Field Id: ", params.fieldToFill);

            JFCustomWidget.setFieldsValueById([{
                id: params.fieldToFill,
                value: signer1Value
            }]);
        }

        function fetchSigners(location) {
            const apiUrl = `http://localhost:7280/api/GetUsersFiltered`;

            progressMessage.textContent = "Retrieving data, please wait...";

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const emails = data || [];
                    if (emails.length > 0) {
                        JFCustomWidget.sendData("data2");
                        signerDropdown.style.display = "block";
                        updateSignerDropdown("signer1", emails);
                        storeSelectedValue("signer1", emails[0].userPrincipalName);
                        setEmailValueToField();
                        progressMessage.textContent = "Data retrieved successfully.";
                    } else {
                        progressMessage.textContent = "No emails found.";
                    }
                })
                .catch(error => {
                    console.error('Error fetching signers:', error);
                    progressMessage.textContent = "Error retrieving data. Please try again.";
                });
        }

        function fillConditionValue(data) {
            console.log("Fill Data", data);

            const selectedLocation = data.value || "";
            if (selectedLocation) {
                fetchSigners(selectedLocation);
            }
        }

        JFCustomWidget.subscribe('populate', fillConditionValue);

        JFCustomWidget.subscribe('ready', function (data) {
            console.log("Data Ready", data);
            console.log("JFCustomWidget", JFCustomWidget)
            console.log("JFCustomWidgetUtils", JFCustomWidgetUtils)
            params = JFCustomWidget.getWidgetSettings();
        });

        JFCustomWidget.subscribe('submit', function (data) {
            console.log("Form submitted with:", data);
        });
    </script>
</body>

</html>