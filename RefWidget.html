<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script type="text/javascript">
        (function () {
            var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
            po.src = '//js.jotform.com/JotFormCustomWidget.min.js?onload=onLoadCallback';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
    </script>
</head>

<body>
    <script type="text/javascript">

        $(function () {
            function UpdateControlForm(containerId, formData, params) {

                /**
               * Exposed
               */
                this.init = init;
                this.makeAPICall = makeAPICall;

                var currFormID = formData["formID"];
                var controlFieldsToUpdate;
                var originalSubmissionId;

                function init() {
                    console.log(formData)
                    console.log(params)

                    JFCustomWidget.getFieldsValueByName(["originalSubmission"], function (res) {
                        console.log("originalSubmission = ", res.data[0].value)
                        originalSubmissionId = res.data[0].value;
                    });

                    //Check if form data is equal to form IDs
                    checkFormId(currFormID);

                    //Make API calls with fields to update

                    //Ref form
                    //TCS App form
                    //Pulse App form

                }

                function makeAPICall() {
                    console.log(`https://acaciumgroup.jotform.com/API/submission/${originalSubmissionId}?apiKey=${params["apiKey"]}`)
                    jQuery.ajax({
                        //url: "https://eu-api.jotform.com/submission/5353380933424302821?apiKey=aa1473ed813357cb04ee2f2128ffd25e",
                        url: `https://acaciumgroup.jotform.com/API/submission/${originalSubmissionId}?apiKey=${params["apiKey"]}`,
                        method: "POST",
                        data: controlFieldsToUpdate,
                        timeout: 60000,
                        success: function (response) {
                            console.log(response);
                            //add result.info to array [1] and return it
                            if (response.result === "YES" && response.errorcode === "Success") {
                                console.log("Pass");
                                // callFinished = true;
                                return
                            }
                            else {
                                console.log("Failed");
                                return
                            }
                        },
                        error: function (response) {
                            console.log(response);
                            return
                        }
                    })

                }

                function checkFormId(currFormID) {
                    console.log(currFormID)
                    var fields = [];
                    /*
                    Control form:
                    78 = status,
                    14 = NMC Pin,
                    227 = On the DBS, 
                    15 = DBS Pin,
                    245 = Widget data
                    */
                    switch (currFormID) {
                        case "221944213799868":
                            //Pulse App
                            fields = ["nmcPin", "doYou", "whatIs", "widgetStorage"];
                            JFCustomWidget.getFieldsValueByName(fields, function (res) {
                                console.log("res value (Pulse App) = ", res.data)
                                controlFieldsToUpdate = {
                                    "submission[78]": "Awaiting Review",
                                    "submission[14]": res.data[0].value,
                                    "submission[227]": res.data[1].value,
                                    "submission[15]": res.data[2].value,
                                    "submission[245]": res.data[3].value
                                }
                                // setTimeout(ProcessData(res), 500);
                            });
                            break;
                        case "222023394876863":
                            //TCS App
                            fields = ["nmcPin", "doYou", "whatIs", "widgetStorage"];
                            JFCustomWidget.getFieldsValueByName(fields, function (res) {
                                console.log("res value (TCS App) = ", res.data)
                                controlFieldsToUpdate = {
                                    "submission[78]": "Awaiting Review",
                                    "submission[14]": res.data[0].value,
                                    "submission[227]": res.data[1].value,
                                    "submission[15]": res.data[2].value,
                                    "submission[245]": res.data[3].value
                                }
                                // setTimeout(ProcessData(res), 500);
                            });
                            break;
                        case "221574004656352":
                            //Pulse Ref
                            break;
                        case "222085492413857":
                            //TCS Ref
                            break;
                        case "222404538712047":
                            //Test remove later
                            fields = ["q5_nmcPin", "q6_doYou", "q7_whatIs", "q8_widgetStorage"];
                            JFCustomWidget.getFieldsValueByName(fields, function (res) {
                                console.log("res value (Test form) = ", res.data)
                                controlFieldsToUpdate = {
                                    "submission[78]": "Awaiting Review",
                                    "submission[14]": res.data[0].value,
                                    "submission[227]": res.data[1].value,
                                    "submission[15]": res.data[2].value,
                                    "submission[245]": res.data[3].value
                                }
                                // setTimeout(ProcessData(res), 500);
                            });
                            break;
                        default:
                            break;
                    }
                }

            }

            JFCustomWidget.subscribe('ready', function (data) {
                // console.log('Education Experience List ready', data);
                var widget = new UpdateControlForm('Test01', data, JFCustomWidget.getWidgetSettings());
                widget.init();

                JFCustomWidget.subscribe('populate', fillConditionValue);

                function fillConditionValue(data) {
                    JFCustomWidget.hideWidgetError();
                }

                JFCustomWidget.subscribe('submit', function () {
                    widget.makeAPICall();

                    // send the data
                    // JFCustomWidget.sendSubmit();
                });

                // console.log(JFCustomWidget)
            });
        })

    </script>
</body>

</html>